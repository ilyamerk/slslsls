<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Калькулятор эффективности и лидерства — Neo</title>
  <style>
  /* Когда страница во фрейме — убираем крупную «шапку»
   и добавляем отступ снизу, чтобы кнопку Bitrix не накрывало */
.is-embed .site-header { display:none; }
.is-embed .container { padding-bottom: 100px; }

/* На всякий: прозрачный фон, чтобы не было белых «полей» вокруг */
html, body { background-clip: border-box; }

    /* ==========================
       Neo UI — youth + innovation
       ========================== */

    :root{
      --bg:#0a0b0f; --bg-2:#0e1117; --glass:rgba(255,255,255,.06);
      --glass-stroke:rgba(255,255,255,.12); --text:#e6eaf2; --muted:#a3adbd;
      --card:#0f141b; --border:rgba(255,255,255,.10);
      --accent:#7c3aed; --accent-2:#22d3ee; --accent-3:#f43f5e;
      --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
      --radius:18px; --shadow:0 10px 30px rgba(2,6,23,.35);
    }

    @media (prefers-color-scheme: light){
      :root{
        --bg:#f7f8fb; --bg-2:#ffffff; --glass:rgba(255,255,255,.7);
        --glass-stroke:rgba(10,10,10,.06); --text:#101828; --muted:#667085;
        --card:#ffffff; --border:rgba(10,10,10,.08);
        --shadow:0 10px 30px rgba(2,6,23,.08);
      }
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;
      color:var(--text); background:var(--bg); letter-spacing:.2px;
    }

    .kpi-hint { display: none !important; }


    /* ===== Background aurora ===== */
    .aurora{
      position:fixed; inset:0; pointer-events:none; z-index:-1;
      background: radial-gradient(800px 500px at -10% 10%, rgba(124,58,237,.25), transparent 70%),
                  radial-gradient(700px 500px at 110% -10%, rgba(34,211,238,.22), transparent 70%),
                  radial-gradient(900px 500px at 50% 120%, rgba(244,63,94,.18), transparent 70%),
                  linear-gradient(180deg, rgba(255,255,255,.03), transparent 40%);
      filter:saturate(120%);
    }

    /* ===== Dotted grid overlay ===== */
    .gridfx{position:fixed; inset:0; pointer-events:none; z-index:0; opacity:.22;}
    .gridfx::before{
      content:""; position:absolute; inset:0; background:
        radial-gradient(circle at 1px 1px, rgba(255,255,255,.18) 1px, transparent 1px);
      background-size:22px 22px;
      mask-image:linear-gradient(to bottom, black, transparent 70%);
    }

    /* ===== Header ===== */
    .site-header{position:relative; background:transparent;}
    .header-inner{max-width:1100px;margin:0 auto;padding:28px 16px 18px;display:flex;align-items:center;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:14px}
    .brand-mark{width:44px;height:44px;border-radius:14px;
      background: conic-gradient(from 210deg,var(--accent),var(--accent-2),var(--accent-3),var(--accent));
      box-shadow:0 10px 40px rgba(124,58,237,.35), inset 0 0 0 1px rgba(255,255,255,.22);
      position:relative; isolation:isolate;}
    .brand-mark::after{content:""; position:absolute; inset:1px; border-radius:12px; background:linear-gradient(180deg,rgba(255,255,255,.2),transparent); mix-blend:overlay}
    .brand-title{font-weight:900;letter-spacing:.4px;font-size:20px}
    .brand-sub{font-size:12px;color:var(--muted)}

    /* ===== Container & card ===== */
    .container{max-width:1100px;margin:18px auto 48px;padding:0 16px}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.03), transparent), var(--card);
      border:1px solid var(--border); border-radius:var(--radius); padding:22px;
      box-shadow:var(--shadow); backdrop-filter:saturate(140%) blur(8px);
    }

    h1{font-size:28px; margin:0 0 10px; letter-spacing:.3px}
    p.sub{margin:0 0 20px;color:var(--muted)}

    /* ===== Grid ===== */
    .grid{display:grid;grid-template-columns:1fr;gap:14px}
    @media(min-width:860px){.grid{grid-template-columns:repeat(2,1fr)}}

    /* ===== Labels & Inputs ===== */
    label{display:block;font-weight:700;margin:6px 0 8px;color:var(--text); opacity:.92}
    input[type="number"], .csel-btn{
      width:100%;padding:12px 14px;border-radius:14px;border:1px solid var(--glass-stroke);
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      color:var(--text);outline:none;transition:border-color .15s ease, box-shadow .15s ease, transform .08s ease;
      box-shadow:inset 0 -1px 0 rgba(255,255,255,.06);
    }
    input[type="number"]:focus, .csel-btn:focus{
      border-color:transparent; box-shadow:0 0 0 6px rgba(124,58,237,.18), 0 6px 24px rgba(34,211,238,.12);
    }
    input[type="number"]::placeholder{color:var(--muted)}

    .row{display:grid;grid-template-columns:1.2fr .8fr;gap:12px;align-items:center}
    .muted{color:var(--muted)}
    .section{margin-top:22px;padding-top:16px;border-top:1px dashed var(--border)}
    .kpi{display:grid;grid-template-columns:1fr 200px;gap:12px;align-items:end}

    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;
      background:linear-gradient(180deg, rgba(124,58,237,.12), rgba(34,211,238,.12));
      border:1px solid rgba(124,58,237,.28);
      color:var(--text);font-size:12px; backdrop-filter:blur(4px) saturate(140%);
    }

    /* ===== Buttons ===== */
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:16px}
    button{padding:11px 16px;border-radius:14px;border:1px solid var(--glass-stroke);
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      color:var(--text);cursor:pointer;transition:transform .08s ease, box-shadow .18s ease, filter .2s ease}
    button:hover{box-shadow:0 12px 26px rgba(2,6,23,.24)}
    button:active{transform:translateY(1px) scale(.99)}
    button.primary{
      background:linear-gradient(135deg,var(--accent),var(--accent-2));
      border:none;color:white;font-weight:800; letter-spacing:.2px;
      box-shadow:0 12px 28px rgba(124,58,237,.35), 0 6px 18px rgba(34,211,238,.25);
    }
    button.primary:hover{filter:brightness(1.03)}
    button.ghost{background:transparent}

    /* ===== Table ===== */
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
    th{color:var(--text);font-weight:800;opacity:.9}

    /* ===== Result stats ===== */
    .result{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:720px){.result{grid-template-columns:repeat(3,1fr)}}
    .stat{position:relative;background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02)), var(--bg-2);
      border:1px solid var(--border);border-radius:16px;padding:14px;overflow:hidden}
    .stat::after{content:"";position:absolute;right:-40px;top:-40px;width:120px;height:120px;border-radius:50%;
      background:radial-gradient(circle at 30% 30%,rgba(124,58,237,.24),transparent 60%)}
    .stat .val{font-size:30px;font-weight:900}
    .hint{font-size:12px;color:var(--muted)}
    .hidden{display:none}

    /* ===== Custom selects ===== */
    .native-hidden{display:none}
    .csel{position:relative}
    .csel-btn{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .csel-arrow{width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-top:7px solid #94a3b8;transition:transform .15s ease}
    .csel.open .csel-arrow{transform:rotate(180deg)}
    .csel-panel{position:absolute;z-index:50;inset:auto 0 0 0;transform:translateY(calc(100% + 6px));
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)), var(--bg-2);
      border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);max-height:260px;overflow:auto}
    .csel-option{padding:10px 12px;cursor:pointer}
    .csel-option:hover{background:rgba(124,58,237,.10)}
    .csel-option[aria-selected="true"]{background:rgba(34,211,238,.12);font-weight:700}
    .csel-panel{scrollbar-width:thin;scrollbar-color: var(--accent) transparent}
    .csel-panel::-webkit-scrollbar{width:10px}
    .csel-panel::-webkit-scrollbar-thumb{background:linear-gradient(180deg,var(--accent),var(--accent-2));border-radius:10px}

    /* ===== Utility ===== */
    .tag{font-size:11px;border:1px solid var(--border);border-radius:999px;padding:3px 8px;color:var(--muted)}

    /* ===== Reduced motion ===== */
    @media (prefers-reduced-motion: reduce){ *{animation:none!important;transition:none!important} }

    /* === Theme toggle & explicit theme maps === */
    .theme-toggle{
      display:inline-flex;align-items:center;justify-content:center;gap:6px;
      width:42px;height:42px;border-radius:999px;border:1px solid var(--glass-stroke);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      cursor:pointer; box-shadow:var(--shadow);
      transition:transform .08s ease, box-shadow .18s ease
    }
    .theme-toggle:hover{box-shadow:0 12px 26px rgba(2,6,23,.24)}
    .theme-toggle:active{transform:translateY(1px) scale(.98)}

    :root[data-theme="dark"]{
      --bg:#0a0b0f; --bg-2:#0e1117; --glass:rgba(255,255,255,.06); --glass-stroke:rgba(255,255,255,.12);
      --text:#e6eaf2; --muted:#a3adbd; --card:#0f141b; --border:rgba(255,255,255,.10);
      --accent:#7c3aed; --accent-2:#22d3ee; --accent-3:#f43f5e; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
      --radius:18px; --shadow:0 10px 30px rgba(2,6,23,.35);
    }
    :root[data-theme="light"]{
      --bg:#f7f8fb; --bg-2:#ffffff; --glass:rgba(255,255,255,.7); --glass-stroke:rgba(10,10,10,.06);
      --text:#101828; --muted:#667085; --card:#ffffff; --border:rgba(10,10,10,.08);
      --accent:#7c3aed; --accent-2:#22d3ee; --accent-3:#f43f5e; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
      --radius:18px; --shadow:0 10px 30px rgba(2,6,23,.08);
    }

    /* === Enhancements: validation, mobile, sticky actions, table scroll === */
    .input-error{border-color:var(--bad)!important; box-shadow:0 0 0 6px rgba(239,68,68,.20), 0 6px 24px rgba(239,68,68,.12)!important;}
    .errmsg{font-size:12px;color:var(--bad);margin-top:6px;display:none}
    .errmsg[aria-hidden="false"]{display:block}

    .table-scroll{overflow-x:auto; -webkit-overflow-scrolling:touch}
    .table-scroll table{min-width:620px}

    @media (max-width: 640px){
      .btns{position:sticky; bottom:0; background:linear-gradient(180deg, rgba(10,11,15,.6), rgba(10,11,15,.9)); backdrop-filter:blur(10px); padding:12px; border-top:1px solid var(--border); z-index:20}
      :root[data-theme="light"] .btns{background:linear-gradient(180deg, rgba(255,255,255,.8), rgba(255,255,255,.95));}
      .section.is-collapsible summary{cursor:pointer; list-style:none; display:flex; align-items:center; gap:8px; font-weight:800; padding:10px 0}
      .section.is-collapsible summary::-webkit-details-marker{display:none}
      .section.is-collapsible{border-top:none; margin-top:12px; padding-top:0}
    }

    .kpi-hint{font-size:12px; color:var(--muted); margin-top:6px}

    /* === Убираем плашку под БЮ === */
    #bu-note { display: none !important; }
  </style>
</head>
<body>
  <div class="aurora" aria-hidden="true"></div>
  <div class="gridfx" aria-hidden="true"></div>

  <header class="site-header" role="banner" aria-label="Нефтьмагистраль — шапка сайта">
    <div class="header-inner">
      <div class="brand">
        <div class="brand-mark" aria-hidden="true"></div>
        <div>
          <div class="brand-title">Калькулятор "Сила Лидера" · KPI</div>
          <div class="brand-sub">Калькулятор эффективности и лидерства</div>
        </div>
      </div>
      <button id="themeToggle" class="theme-toggle" aria-pressed="false" aria-label="Переключатель темы" title="Переключить тему">
        <span data-sun>☀️</span><span data-moon style="display:none">🌙</span>
      </button>
    </div>
  </header>

  <div class="container">
    <div class="card">
      <h1>Калькулятор эффективности и лидерства</h1>
      <p class="sub">Выберите Бизнес-Юнит и должность, затем заполните показатели. Формулы и пороги строго соответствуют ТЗ.</p>

      <div class="grid">
        <div>
          <label for="bu">Бизнес-Юнит</label>
          <!-- Placeholder-опция — selected + disabled -->
          <select id="bu" class="native-hidden">
            <option value="" selected disabled>— выберите —</option>
            <option value="АЗС">АЗС</option>
            <option value="МБ">МБ</option>
            <option value="БК">БК</option>
            <option value="ФК">ФК</option>
          </select>
          <div id="bu-csel" class="csel" aria-haspopup="listbox" aria-expanded="false"></div>
        </div>
        <div>
          <label for="role">Должность</label>
          <select id="role" class="native-hidden">
            <option value="" selected disabled>— выберите —</option>
            <option>ОД</option>
            <option>РУ</option>
            <option>РМ</option>
            <option>Директор</option>
            <option>Зам.Директора</option>
            <option>Зам. Директора по направлению Кафе</option>
            <option>Зам. Директора по направлению розницы</option>
          </select>
          <div id="role-csel" class="csel" aria-haspopup="listbox" aria-expanded="false"></div>
        </div>
      </div>

      <!-- KPI: Бизнес -->
      <div class="section" id="business-section">
        <div class="row">
          <h3 style="margin:0">Показатели «на бизнес»</h3>
          <span class="pill" id="bu-note">—</span>
        </div>
        <div class="kpi"><label id="lbl-q">Индекс качества, %</label><input type="number" step="0.01" id="idxQuality" placeholder="например, 95.5" /></div>
        <div class="kpi"><label id="lbl-t1">Выполнение плана по ТО, %</label><input type="number" step="0.01" id="idxTO" placeholder="например, 97" /></div>
        <div class="kpi"><label id="lbl-t2">Выполнение плана по проникновению МП, %</label><input type="number" step="0.01" id="idxMP" placeholder="например, 96" /></div>
      </div>

      <!-- KPI: Лидерство -->
      <div class="section" id="lead-section">
        <h3 style="margin:0 0 10px">Показатели лидерства</h3>
        <div class="kpi"><label>Аксиология, %</label><input type="number" step="0.01" id="axio" placeholder="например, 82" /></div>
        <div class="kpi"><label>HR-индекс, %</label><input type="number" step="0.01" id="hr" placeholder="например, 88" /></div>
        <div class="kpi"><label>Ассессмент, балл</label>
  	  <input type="number" id="assess" placeholder="например, 2.7"
               min="0" max="3" step="1" />
        </div>


        <!-- Доп. для ФК -->
        <div class="kpi" id="prodWrap" style="display:none">
          <label for="productivity">Производительность, %</label>
          <input type="number" step="0.01" id="productivity" placeholder="например, 93" />
        </div>
        <div class="kpi" id="budgetWrap" style="display:none">
          <label for="budgetExec">% исполнения бюджета, %</label>
          <input type="number" step="0.01" id="budgetExec" placeholder="например, 96" />
        </div>
        <div class="kpi" id="teamIndexWrap" style="display:none">
          <label for="teamIndex">Балл (индекс команды)</label>
          <input type="number" id="teamIndex" placeholder="например, 2" min="0" max="3" step="1" />
        </div>

        <div class="section">
          <h4 style="margin:0 0 10px">Нарушения</h4>
          <div id="violations-wrap"></div>
        </div>
      </div>

      <div class="btns">
        <button class="primary" id="calc">Рассчитать</button>
        <button class="ghost" id="reset">Сбросить</button>
      </div>

      <div class="section hidden" id="results">
        <h3 style="margin:0 0 10px">Результаты</h3>
        <div class="result">
          <div class="stat"><div class="muted">Эффективность на бизнес (среднее)</div><div class="val" id="businessScore">—</div></div>
          <div class="stat"><div class="muted">Лидерство (итог − штрафы)</div><div class="val" id="leadershipScore">—</div></div>
          <div class="stat"><div class="muted">Сумма штрафов за нарушения</div><div class="val" id="penaltySum">—</div></div>
        </div>

        <div class="section hidden" id="bk-extra">
          <h4 id="clustersTitle" style="margin:0 0 8px">Кластеры</h4>
          <div class="result">
            <div class="stat"><div class="muted">Кластер эффективности на бизнес</div><div class="val" id="clusterBiz">—</div></div>
            <div class="stat"><div class="muted">Кластер лидерства</div><div class="val" id="clusterLead">—</div></div>
            <div class="stat"><div class="muted">Премия, ₽</div><div class="val" id="bonus">—</div></div>
          </div>
          <p class="muted" id="finalLabel" style="margin-top:8px"></p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== Утилиты =====
    const $ = (sel)=>document.querySelector(sel);
    const fmt = (x)=> Number.isFinite(x) ? x.toFixed(2) : '—';
    const num = (v)=>{ if (v===''||v==null) return null; v = String(v).replace(',', '.'); const n = Number(v); return Number.isFinite(n) ? n : null; };

    // ===== Custom Select (generic) =====
    function mountCustom(selId, mountId){
      const sel = document.getElementById(selId);
      const mount = document.getElementById(mountId);
      if(!sel || !mount) return;

      const allOpts = Array.from(sel.options);
      const opts = allOpts.filter(o=>!o.disabled);
      const current = sel.value || '';
      const placeholder = (allOpts.find(o=>o.disabled)?.text) || '— выберите —';
      const currentText = current
        ? (opts.find(o=>o.value===current)?.text || placeholder)
        : placeholder;

      mount.innerHTML = `
        <button type="button" class="csel-btn" id="${mountId}Btn" aria-haspopup="listbox" aria-expanded="false">
          <span id="${mountId}Label">${currentText}</span>
          <span class="csel-arrow" aria-hidden="true"></span>
        </button>
        <div class="csel-panel" id="${mountId}Panel" role="listbox" tabindex="-1" style="display:none"></div>`;

      const panel = document.getElementById(`${mountId}Panel`);
      panel.innerHTML = opts.map(o=>`<div class="csel-option" role="option" data-value="${o.value}" aria-selected="${o.value===current}">${o.text}</div>`).join('');

      const btn = document.getElementById(`${mountId}Btn`);
      function open(){ mount.classList.add('open'); panel.style.display='block'; mount.setAttribute('aria-expanded','true'); btn.setAttribute('aria-expanded','true'); panel.focus(); }
      function close(){ mount.classList.remove('open'); panel.style.display='none'; mount.setAttribute('aria-expanded','false'); btn.setAttribute('aria-expanded','false'); }

      btn.onclick = (e)=>{ e.stopPropagation(); mount.classList.contains('open') ? close() : open(); };
      document.addEventListener('click', (e)=>{ if(!mount.contains(e.target)) close(); });

      panel.addEventListener('click', (e)=>{
        const item = e.target.closest('.csel-option'); if(!item) return;
        const val = item.getAttribute('data-value'); const text = item.textContent;
        sel.value = val;
        panel.querySelectorAll('.csel-option').forEach(n=>n.setAttribute('aria-selected', String(n===item)));
        document.getElementById(`${mountId}Label`).textContent = text;
        sel.dispatchEvent(new Event('change', {bubbles:true}));
        close();
      });
    }
    function mountBUCustom(){ mountCustom('bu','bu-csel'); }
    function mountRoleCustom(){ mountCustom('role','role-csel'); }

    // ===== Нарушения по БЮ =====
    const VIOLATIONS_DEF = {
      'АЗС': [
        {name:'Воровство (товара, продукции, денег, топлива, баллов МП)', weight:0.5},
        {name:'Прием сдача смены (ПСС), инкассация', weight:0.5},
        {name:'Недонесение информации до отдела контроля и видеофиксации', weight:0.5},
        {name:'Вынос просроченной продукции', weight:0.25},
        {name:'Нарушение кассовой дисциплины (клиентинг, телефоны, использование МП на смене)', weight:0.25},
        {name:'Повреждение имущества по вине сотрудника', weight:0.25},
        {name:'Продажа мимо без умысла / отмены / возвраты, где товар ушёл', weight:0.1},
        {name:'Инкассация МСО', weight:0.1},
        {name:'Злоупотребление питанием персонала', weight:0.1},
      ],
      'МБ': [
        {name:'Воровство (товара, продукции, денег, топлива, баллов МП)', weight:0.5},
        {name:'Недонесение информации до отдела контроля и видеофиксации', weight:0.5},
        {name:'Вынос просроченной продукции', weight:0.25},
        {name:'Нарушение кассовой дисциплины (клиентинг, телефоны, использование МП на смене)', weight:0.25},
        {name:'Повреждение имущества по вине сотрудника', weight:0.25},
        {name:'Продажа мимо без умысла / отмены / возвраты, где товар ушёл', weight:0.1},
        {name:'Злоупотребление питанием персонала', weight:0.1},
      ],
      'БК': [
        {name:'Воровство (товара, продукции, денег, топлива, баллов МП)', weight:0.5},
        {name:'Прием сдача смены (ПСС), инкассация', weight:0.5},
        {name:'Недонесение информации до отдела контроля и видеофиксации', weight:0.5},
        {name:'Вынос просроченной продукции', weight:0.25},
        {name:'Нарушение кассовой дисциплины (клиентинг, телефоны, использование МП на смене)', weight:0.25},
        {name:'Повреждение имущества по вине сотрудника', weight:0.25},
        {name:'Продажа мимо без умысла / отмены / возвраты, где товар ушёл', weight:0.1},
        {name:'Злоупотребление питанием персонала', weight:0.1},
      ],
      'ФК': [
        {name:'Воровство (товара, продукции, денег, топлива, баллов МП)', weight:0.5},
        {name:'Прием сдача смены (ПСС), инкассация', weight:0.5},
        {name:'Недонесение информации до отдела контроля и видеофиксации', weight:0.5},
        {name:'Вынос просроченной продукции', weight:0.25},
        {name:'Нарушение кассовой дисциплины (клиентинг, телефоны, использование МП на смене)', weight:0.25},
        {name:'Повреждение имущества по вине сотрудника', weight:0.25},
        {name:'Продажа мимо без умысла / отмены / возвраты, где товар ушёл', weight:0.1},
        {name:'Инкассация МСО', weight:0.1},
        {name:'Злоупотребление питанием персонала', weight:0.1},
      ],
    };

    // ===== Роли ФК =====
    const FC_ROLES = [
      'Директор Производства','Бренд-Шеф','Заведующий кулинарным производством',
      'Заведующий кондитерским и пекарским производством','Заведующий цехом','Начальник цеха',
      'Руководитель мясного производства','Руководитель хлебопекарного производства','Начальник мясного цеха'
    ];
    function addFCRolesIfNeeded(){
      const selRole = document.getElementById('role');
      const bu = document.getElementById('bu').value;
      if(bu!=='ФК') return;
      const current = Array.from(selRole.options).map(o=>o.textContent.trim());
      FC_ROLES.forEach(r=>{ if(!current.includes(r)) selRole.insertAdjacentHTML('beforeend', `<option>${r}</option>`); });
    }

    // ===== Базовые скоринги =====
    function scoreIndexQuality(bu, val){
      if(val==null) return 0;
      if(bu==='БК'){
        if(val<90) return 1; if(val>=90 && val<=93) return 2; return 3;
      } else { // АЗС, МБ, ФК
        if(val<90) return 1; if(val>=90 && val<=96) return 2; return 3;
      }
    }
    function scoreTO(val){ if(val==null) return 0; if(val<94) return 1; if(val>=94 && val<97) return 2; return 3; }
    function scoreMP(val){ if(val==null) return 0; if(val<95) return 1; if(val>=95 && val<97) return 2; return 3; }

    function scoreAxiology(val){ if(val==null) return 0; if(val<=60) return 1; if(val>60 && val<=80) return 2; return 3; }
    function scoreHR(val){ if(val==null) return 0; if(val<85) return 1; if(val>=85 && val<90) return 2; return 3; }
    function scoreAssess(val){ if(val==null) return 0; if(val<=1.9) return 1; if(val>1.9 && val<2.8) return 2; return 3; }

    // ===== ФК скоринги =====
    function scoreIdxQuality_FC(v){ if(v==null) return 0; if(v<90) return 1; if(v<=95) return 2; return 3; }
    function scorePlanProd_FC(v){ if(v==null) return 0; if(v<95) return 1; if(v<=98) return 2; return 3; }
    function scoreUnderload_FC(v){ if(v==null) return 0; if(v>2) return 1; if(v>=1 && v<=2) return 2; if(v<1) return 3; return 0; }
    function scoreProductivity(v){ if(v==null) return 0; if(v<90) return 1; if(v<=95) return 2; return 3; }
    function scoreBudgetExec(v){ if(v==null) return 0; if(v<90) return 1; if(v<=95) return 2; return 3; }

    // ===== Отрисовка нарушений =====
    function renderViolations(bu){
      const wrap = document.getElementById('violations-wrap');
      wrap.innerHTML = '';
      if(!bu){ wrap.innerHTML = '<p class="muted">Сначала выберите Бизнес-Юнит выше.</p>'; return; }
      const list = VIOLATIONS_DEF[bu] || [];
      const table = document.createElement('table');
      table.innerHTML = `<thead><tr><th>Нарушение</th><th style="width:140px">Кол-во</th><th style="width:120px">Вес</th></tr></thead>`;
      const tbody = document.createElement('tbody');
      list.forEach((v, i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${v.name}</td>
          <td><input type="number" min="0" step="any" value="0" data-viol-idx="${i}" style="width:120px"></td>
          <td><span class="pill">-${v.weight}</span></td>`;
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      wrap.appendChild(table);

      // MOBILE: горизонтальный скролл
      const tbl = wrap.querySelector('table');
      if(tbl){
        const div = document.createElement('div');
        div.className = 'table-scroll';
        tbl.parentElement.insertBefore(div, tbl);
        div.appendChild(tbl);
      }

      ensureViolationDefaults();
    }

    // ===== Примечание под БЮ =====
    function updateBuNote(bu){
      const note = document.getElementById('bu-note');
      if(!bu){ note.textContent = '—'; return; }
      if(bu==='БК') note.textContent = 'Индекс качества: 2 балла при 90–93%, 3 балла > 93%';
      else if(bu==='ФК') note.textContent = 'Индекс качества: 2 балла при 90–95%, 3 балла > 95%';
      else note.textContent = 'Индекс качества: 2 балла при 90–96%, 3 балла > 96%';
    }

    // ===== Бизнес-оценка =====
    function computeBusinessScore(bu){
      const role = $('#role').value;
      const q = num($('#idxQuality').value);
      const t1 = num($('#idxTO').value);
      const t2 = num($('#idxMP').value);

      if(bu==='ФК' && FC_ROLES.includes(role)){
        const s1 = scoreIdxQuality_FC(q);
        const s2 = scorePlanProd_FC(t1);
        const s3 = scoreUnderload_FC(t2);
        return (s1 + s2 + s3) / 3;
      }
      const s1 = scoreIndexQuality(bu,q);
      const s2 = scoreTO(t1);
      const s3 = scoreMP(t2);
      return (s1 + s2 + s3) / 3;
    }

    // ===== Лидерство =====
    function computeLeadershipScore(){
      const bu = $('#bu').value; const role = $('#role').value;
      const ax = scoreAxiology(num($('#axio').value));
      const hr = scoreHR(num($('#hr').value));
      const as = scoreAssess(num($('#assess').value));

      // штрафы
      const violInputs = document.querySelectorAll('[data-viol-idx]');
      let penalty = 0;
      (VIOLATIONS_DEF[bu]||[]).forEach((v, i)=>{
        const inp = Array.from(violInputs).find(n=>Number(n.dataset.violIdx)===i);
        const cnt = num(inp?.value)||0;
        penalty += cnt * v.weight;
      });

      if(bu==='ФК' && FC_ROLES.includes(role)){
        const prod = scoreProductivity(num($('#productivity').value));
        const teamRaw = num($('#teamIndex').value);
        const team = Number.isFinite(teamRaw) ? teamRaw : 0;
        if(role==='Директор Производства'){
          const budg = scoreBudgetExec(num($('#budgetExec').value));
          const mid = (ax + as + budg) / 3; // среднее Аксиология, Ассессмент и % исполнения бюджета
          const total = (mid + hr + prod + team) / 4;
          return {score: total - penalty, penalty};
        }
        const mid = (ax + as) / 2; // среднее Аксиология и Ассессмент
        const total = (mid + hr + prod) / 3;
        return {score: total - penalty, penalty};
      }
      const base = (ax + hr + as) / 3;
      return {score: base - penalty, penalty};
    }

    // ===== Кластеры =====
    function classifyByRole(role, bizScore, leadScore){
      const group1 = ['ОД','РУ','РМ'];
      const group2 = ['Директор','Зам.Директора','Зам. Директора по направлению Кафе','Зам. Директора по направлению розницы'];
      let clusterBiz='—', clusterLead='—';
      if(group1.includes(role)){
        if(bizScore<=2.29) clusterBiz='C'; else if(bizScore>2.29 && bizScore<=2.39) clusterBiz='B'; else if(bizScore>2.39) clusterBiz='A';
        if(leadScore<=2.39) clusterLead='C'; else if(leadScore>2.39 && leadScore<=2.59) clusterLead='B'; else if(leadScore>2.59) clusterLead='A';
      } else if(group2.includes(role)){
        if(bizScore<=1.89) clusterBiz='C'; else if(bizScore>1.89 && bizScore<=2.59) clusterBiz='B'; else if(bizScore>2.59) clusterBiz='A';
        if(leadScore<=1.89) clusterLead='C'; else if(leadScore>1.89 && leadScore<=2.59) clusterLead='B'; else if(leadScore>2.59) clusterLead='A';
      }
      return {clusterBiz, clusterLead};
    }
    function classifyFC(role, bizScore, leadScore){
      let clusterBiz, clusterLead;
      if(role==='Директор Производства'){
        if(bizScore<=2.29) clusterBiz='C'; else if(bizScore<=2.39) clusterBiz='B'; else clusterBiz='A';
        if(leadScore<=1.89) clusterLead='C'; else if(leadScore<=2.59) clusterLead='B'; else clusterLead='A';
      } else {
        if(bizScore<=1.9) clusterBiz='C'; else if(bizScore<=2.6) clusterBiz='B'; else clusterBiz='A';
        if(leadScore<=1.9) clusterLead='C'; else if(leadScore<=2.6) clusterLead='B'; else clusterLead='A';
      }
      return {clusterBiz, clusterLead};
    }

    // ===== Премии =====
    function bonusBK(cb, cl){
      const map = {
        'A|A': {bonus:50000, label:'Высокая эффективность / Высокое лидерство'},
        'A|B': {bonus:25000, label:'Высокая эффективность / Среднее лидерство'},
        'B|A': {bonus:25000, label:'Средняя эффективность / Высокое лидерство'},
        'C|A': {bonus:0, label:'Низкая эффективность / Высокое лидерство'},
        'C|B': {bonus:0, label:'Низкая эффективность / Среднее лидерство'},
        'C|C': {bonus:0, label:'Низкая эффективность / Низкое лидерство'},
        'A|C': {bonus:0, label:'Высокая эффективность / Низкое лидерство'},
        'B|C': {bonus:0, label:'Средняя эффективность / Низкое лидерство'},
        'B|B': {bonus:0, label:'Средняя эффективность / Среднее лидерство'},
      };
      return map[`${cb}|${cl}`] || {bonus:0,label:'—'};
    }

    // ===== UI-конфиг =====
    function configureUI(){
      const bu = $('#bu').value; const role = $('#role').value;
      if(bu==='ФК' && FC_ROLES.includes(role)){
        $('#lbl-q').textContent = 'Индекс качества, %';
        $('#lbl-t1').textContent = 'Выполнение плана выпуска продукции, %';
        $('#lbl-t2').textContent = '% Недогрузов на сеть, %';
      } else {
        $('#lbl-q').textContent = 'Индекс качества, %';
        $('#lbl-t1').textContent = 'Выполнение плана по ТО, %';
        $('#lbl-t2').textContent = 'Выполнение плана по проникновению МП, %';
      }
      $('#prodWrap').style.display = (bu==='ФК' && FC_ROLES.includes(role)) ? '' : 'none';
      $('#budgetWrap').style.display = (bu==='ФК' && role==='Директор Производства') ? '' : 'none';
      $('#teamIndexWrap').style.display = (bu==='ФК' && role==='Директор Производства') ? '' : 'none';
    }

    // ===== Значения нарушений по умолчанию =====
    function ensureViolationDefaults(){
      document
        .querySelectorAll('#violations-wrap input[type="number"][data-viol-idx]')
        .forEach(el=>{
          if(el.value === '' || el.value == null){
            el.value = '0';
          }
          if(!el.dataset.violationHandler){
            el.addEventListener('blur', ()=>{
              if(el.value === '' || el.value == null){
                el.value = '0';
                validateField(el);
              }
            });
            el.dataset.violationHandler = '1';
          }
        });
    }

    // ===== Theme toggle logic =====
    (function(){
      const root = document.documentElement;
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)');
      const btn = document.getElementById('themeToggle');

      function updateToggle(){
        if(!btn) return;
        const t = root.getAttribute('data-theme');
        const isDark = t ? t==='dark' : prefersDark.matches;
        btn.setAttribute('aria-pressed', String(isDark));
        const sun = btn.querySelector('[data-sun]');
        const moon = btn.querySelector('[data-moon]');
        if(sun && moon){ sun.style.display = isDark ? 'none' : 'inline'; moon.style.display = isDark ? 'inline' : 'none'; }
        btn.title = isDark ? 'Светлая тема' : 'Тёмная тема';
      }
      function applySavedTheme(){
        const saved = localStorage.getItem('theme');
        if(saved==='light' || saved==='dark'){
          root.setAttribute('data-theme', saved);
        } else {
          root.removeAttribute('data-theme');
        }
        updateToggle();
      }
      function toggleTheme(){
        const cur = root.getAttribute('data-theme');
        let next;
        if(cur){ next = cur==='dark' ? 'light' : 'dark'; }
        else { next = prefersDark.matches ? 'light' : 'dark'; }
        root.setAttribute('data-theme', next);
        localStorage.setItem('theme', next);
        updateToggle();
      }
      if(btn){ btn.addEventListener('click', toggleTheme); }
      prefersDark.addEventListener('change', ()=>{ if(!root.getAttribute('data-theme')) updateToggle(); });
      applySavedTheme();
    })();

    /* ======= ENHANCEMENTS: AUTOSAVE, VALIDATION, MOBILE ACCORDION, LIVE KPI HINTS ======= */

    // Registry helpers
    function getAllFields(){
      const fields = ['#idxQuality','#idxTO','#idxMP','#axio','#hr','#assess','#productivity','#budgetExec','#teamIndex'];
      return fields.map(s=>document.querySelector(s)).filter(Boolean);
    }
    function getViolationInputs(){
      return Array.from(document.querySelectorAll('[data-viol-idx]'));
    }
    function getSelectors(){
      return [document.getElementById('bu'), document.getElementById('role')];
    }

    // AUTOSAVE
    const STORAGE_KEY = 'kpi_calc_state_v2';
    function autosaveCollect(){
      const data = {
        selectors: Object.fromEntries(getSelectors().map(s=>[s.id, s.value])),
        fields: Object.fromEntries(getAllFields().map(i=>[i.id, i.value])),
        violations: getViolationInputs().map(i=>({idx:i.dataset.violIdx, val:i.value})),
        resultsVisible: !document.getElementById('results').classList.contains('hidden'),
        extraVisible: !document.getElementById('bk-extra').classList.contains('hidden')
      };
      return data;
    }
    function autosaveApply(data){
      if(!data) return;
      const sels = getSelectors();
      sels.forEach(s=>{
        if(data.selectors && data.selectors[s.id]!=null){
          s.value = data.selectors[s.id];
          s.dispatchEvent(new Event('change',{bubbles:true}));
        }
      });
      requestAnimationFrame(()=>{
        getAllFields().forEach(i=>{ if(data.fields && data.fields[i.id]!=null){ i.value = data.fields[i.id]; }});
        if(data.violations && data.violations.length){
          getViolationInputs().forEach(inp=>{
            const found = data.violations.find(v=>String(v.idx)===String(inp.dataset.violIdx));
            if(found) inp.value = found.val;
          });
        }
        if(data.resultsVisible) document.getElementById('results').classList.remove('hidden');
        if(data.extraVisible) document.getElementById('bk-extra').classList.remove('hidden');

        ensureViolationDefaults();
      });
    }
    function autosaveInit(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(raw){ autosaveApply(JSON.parse(raw)); }
      }catch(e){ console.warn('autosave load error', e); }
      const save = ()=>{
        try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(autosaveCollect())); }catch(e){}
      };
      document.addEventListener('input', (e)=>{ if(e.target.matches('input, select')) save(); }, true);
      document.addEventListener('change', (e)=>{ if(e.target.matches('input, select')) save(); }, true);
      document.getElementById('reset').addEventListener('click', ()=>{
        try{ localStorage.removeItem(STORAGE_KEY);}catch(e){}
      });
    }

    // VALIDATION
    const VALID = {
  // проценты: разрешаем любые значения ≥ 0
  percent: (v)=> v==='' || v==null || (isFinite(v) && v>=0),
  // для нарушений: требуем число ≥0 и поле не может быть пустым
  positiveNumber: (v)=>{
    if(v==='' || v==null) return false;
    const n = Number(String(v).replace(',', '.'));
    return Number.isFinite(n) && n>=0;
  },
  // ассессмент: целые 0–3
  assess: (v)=>{
    if (v==='' || v==null) return true;
    const n = Number(v);
    return Number.isFinite(n) && n>=0 && n<=3;
  }
};
    function ensureErrMsg(el){
      let msg = el.parentElement.querySelector('.errmsg');
      if(!msg){
        msg = document.createElement('div');
        msg.className = 'errmsg';
        msg.setAttribute('aria-hidden','true');
        el.parentElement.appendChild(msg);
      }
      return msg;
    }
    function validateField(el){
      const id = el.id || '';
      const valRaw = el.value;
      let ok = true, text='';
      if(['idxQuality','idxTO','idxMP','axio','hr','productivity','budgetExec'].includes(id)){
        ok = VALID.percent(valRaw);
        if(!ok) text = 'Введите процент от 0 до 150';
      } else if(id==='assess'){
        ok = VALID.assess(valRaw);
        if(!ok) text = 'Ассессмент должен быть в диапазоне 0–3';
      } else if(id==='teamIndex'){
        ok = VALID.assess(valRaw);
        if(!ok) text = 'Балл индекса команды должен быть целым числом 0–3';
      } else if(el.hasAttribute('data-viol-idx')){
        ok = VALID.positiveNumber(valRaw);
        if(!ok) text = 'Заполните поле (число ≥ 0)';
      }
      el.classList.toggle('input-error', !ok);
      const msg = ensureErrMsg(el);
      msg.textContent = text;
      msg.setAttribute('aria-hidden', ok ? 'true' : 'false');
      return ok;
    }
    function validateAll(){
      const fields = getAllFields();
      const viols = getViolationInputs();
      let ok = true;
      [...fields, ...viols].forEach(el=>{ if(!validateField(el)) ok=false; });
      return ok;
    }
    function attachValidation(){
      document.addEventListener('input', (e)=>{
        const el = e.target;
        if(!(el instanceof HTMLInputElement)) return;
        validateField(el);
        if(el.closest('.kpi')) updateKpiHint(el);
      }, true);
      // Guard calculate
      const calcBtn = document.getElementById('calc');
      calcBtn.addEventListener('click', (e)=>{
        if(!validateAll()){
          e.stopImmediatePropagation?.();
          e.stopPropagation();
          e.preventDefault();
          alert('Проверьте ввод: есть ошибки в полях.');
        }
      }, true);
    }

    // LIVE KPI HINTS
    function getKpiHint(el){
      const bu = $('#bu').value;
      const role = $('#role').value;
      const v = num(el.value);
      let score = null, label = '';
      switch(el.id){
        case 'idxQuality':
          score = (bu==='ФК' && FC_ROLES.includes(role)) ? scoreIdxQuality_FC(v) : scoreIndexQuality(bu, v);
          label = 'Индекс качества'; break;
        case 'idxTO':
          score = (bu==='ФК' && FC_ROLES.includes(role)) ? scorePlanProd_FC(v) : scoreTO(v);
          label = (bu==='ФК' && FC_ROLES.includes(role)) ? 'План выпуска продукции' : 'Выполнение плана по ТО'; break;
        case 'idxMP':
          score = (bu==='ФК' && FC_ROLES.includes(role)) ? scoreUnderload_FC(v) : scoreMP(v);
          label = (bu==='ФК' && FC_ROLES.includes(role)) ? '% Недогрузов' : 'Проникновение МП'; break;
        case 'axio': score = scoreAxiology(v); label='Аксиология'; break;
        case 'hr': score = scoreHR(v); label='HR-индекс'; break;
        case 'assess': score = scoreAssess(v); label='Ассессмент'; break;
        case 'productivity': score = scoreProductivity(v); label='Производительность'; break;
        case 'budgetExec': score = scoreBudgetExec(v); label='% исполнения бюджета'; break;
        case 'teamIndex': score = Number.isFinite(v) ? v : null; label='Балл (индекс команды)'; break;
      }
      if(score==null) return '';
      return `Баллы за «${label}»: ${fmt(score)}/3`;
    }
    function updateKpiHint(el){
      let hint = el.parentElement.querySelector('.kpi-hint');
      if(!hint){
        hint = document.createElement('div');
        hint.className = 'kpi-hint';
        el.parentElement.appendChild(hint);
      }
      const text = getKpiHint(el);
      hint.textContent = text;
      hint.style.display = text ? '' : 'none';
    }
    function initKpiHints(){
      getAllFields().forEach(updateKpiHint);
    }

    // MOBILE: «аккордеоны» на малых экранах
    function makeSectionsCollapsibleIfMobile(){
      const isMobile = window.matchMedia('(max-width: 640px)').matches;
      const ids = ['business-section','lead-section','results'];
      ids.forEach(id=>{
        const sec = document.getElementById(id);
        if(!sec) return;
        if(isMobile && !sec.dataset.collapsible){
          const wrapper = document.createElement('details');
          wrapper.open = (id!=='results');
          wrapper.className = 'section is-collapsible';
          const summary = document.createElement('summary');
          const header = sec.querySelector('h3, h4');
          summary.textContent = header ? header.textContent : (id==='business-section'?'Показатели «на бизнес»': id==='lead-section'?'Показатели лидерства':'Результаты');
          sec.insertAdjacentElement('beforebegin', wrapper);
          wrapper.appendChild(summary);
          const kids = Array.from(sec.childNodes);
          kids.forEach(n=>wrapper.appendChild(n));
          sec.remove();
          wrapper.id = id;
          wrapper.dataset.collapsible = '1';
        }
      });
    }

    // ===== Инициализация =====
    renderViolations('');
    updateBuNote('');
    mountBUCustom();
    mountRoleCustom();

    // Слушатели
    document.getElementById('bu').addEventListener('change', e=>{
      // сброс должности на placeholder при смене БЮ
      const roleSel = document.getElementById('role');
      roleSel.value = '';
      roleSel.dispatchEvent(new Event('change', {bubbles:true}));
      mountRoleCustom();

      updateBuNote(e.target.value);
      addFCRolesIfNeeded();
      mountRoleCustom();      // роли могли измениться
      mountBUCustom();        // перерисовать кастом BU
      renderViolations(e.target.value);
      configureUI();
      document.getElementById('bk-extra').classList.add('hidden');
    });

    document.getElementById('role').addEventListener('change', ()=>{
      configureUI();
      mountRoleCustom(); // подсветка выбранного в кастоме
    });

    document.getElementById('reset').addEventListener('click', ()=>{ location.reload(); });

    document.getElementById('calc').addEventListener('click', ()=>{
      const bu = $('#bu').value; const role = $('#role').value;
      if(!bu || !role){ alert('Пожалуйста, выберите Бизнес-Юнит и Должность.'); return; }

      const biz = computeBusinessScore(bu);
      const {score:lead, penalty} = computeLeadershipScore();

      $('#businessScore').textContent = fmt(biz);
      $('#leadershipScore').textContent = fmt(lead);
      $('#penaltySum').textContent = '-' + fmt(penalty);
      $('#results').classList.remove('hidden');

      const extra = $('#bk-extra');
      const isFCSpecial = (bu==='ФК' && FC_ROLES.includes(role));
      const {clusterBiz, clusterLead} = isFCSpecial
        ? classifyFC(role, biz, lead)
        : classifyByRole(role, biz, lead);

      if(clusterBiz !== '—' && clusterLead !== '—'){
        $('#clusterBiz').textContent = clusterBiz;
        $('#clusterLead').textContent = clusterLead;
        const {bonus,label} = bonusBK(clusterBiz, clusterLead);
        $('#bonus').textContent = bonus.toLocaleString('ru-RU');
        $('#finalLabel').textContent = label;
        extra.classList.remove('hidden');
      } else {
        $('#clusterBiz').textContent = '—';
        $('#clusterLead').textContent = '—';
        $('#bonus').textContent = '—';
        $('#finalLabel').textContent = '—';
        extra.classList.add('hidden');
      }
    });

    // Первичное состояние + улучшения
    configureUI();
    attachValidation();
    initKpiHints();
    autosaveInit();
    makeSectionsCollapsibleIfMobile();
    window.addEventListener('resize', makeSectionsCollapsibleIfMobile);
    // === EMBED/IFRAME: автоподстройка высоты ===
(function(){
  // помечаем «режим встраивания» (страница не в топ-окне)
  const isEmbed = (window.self !== window.top);
  if(isEmbed){ document.documentElement.classList.add('is-embed'); }

  // шлём высоту родителю (Bitrix-странице)
  function postHeight(){
    // берём «наивысшую» из вариантов, чтобы точно покрыть контент
    const h = Math.max(
      document.body.scrollHeight,
      document.documentElement.scrollHeight,
      document.body.offsetHeight,
      document.documentElement.offsetHeight,
      document.body.clientHeight,
      document.documentElement.clientHeight
    );
    // можно указать конкретный origin вместо '*', если известно
    window.parent.postMessage({ type:'kpi_calc_height', height:h }, '*');
  }

  // при загрузке + при любых изменениях верстки
  window.addEventListener('load', postHeight);
  window.addEventListener('resize', postHeight);
  new MutationObserver(postHeight).observe(document.body, {childList:true,subtree:true,attributes:true});
  if('ResizeObserver' in window){
    new ResizeObserver(postHeight).observe(document.documentElement);
  }

  // на всякий — переотправка через таймауты (случай медленной отрисовки)
  setTimeout(postHeight, 300);
  setTimeout(postHeight, 1000);
})();
  </script>
</body>
</html>